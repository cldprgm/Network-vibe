{% load tz %}
{% load static %}
<hr style='width: 45rem;'>
{% for post in posts %}
    <div class="text-white card custom-card mb-0" style='width: 45rem; border-radius: 18px;'>
        <div class="card-body">
            <h6 class="text-white d-flex align-items-center">
                <!-- Avatar -->
                <img
                  src="{{ post.author.profile.avatar.url }}"
                  class="rounded-circle"
                  alt="{{ profile }}"
                  width="35"
                  height="35"
                >
                
                <!-- Text -->
                <div class="ms-2 d-flex flex-column">
                    <!-- Nickname + time -->
                    <div>
                        <a
                          class="custom-a fw-bold"
                          href="{{ post.author.profile.get_absolute_url }}"
                        >
                            {{ post.author.username }}
                        </a>
                        <span style="color: rgba(255, 255, 255, 0.75);">â€¢ {{ post.created|timesince }} ago</span>
                    </div>         
                </div>

                <!-- Ellipsis menu -->
                <span class="ms-auto">
                    <button class="btn btn-sm header-toolbar-button" 
                        style='border-color: transparent;' 
                        type="button" 
                        aria-label="More options" 
                        id="postMenu{{ post.id }}" 
                        data-bs-toggle="dropdown" 
                        aria-expanded="false">
                        <svg fill="currentColor" height="16" viewBox="0 0 20 20" width="16" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6 10a2 2 0 1 1-4 0 2 2 0 0 1 4 0Zm4-2a2 2 0 1 0 0 4 2 2 0 0 0 0-4Zm6 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4Z"></path>
                        </svg>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="postMenu{{ post.id }}" style='background-color:rgb(26, 30, 34); border-color: transparent; border-radius: 12px;'>
                        <li>
                            <a class="dropdown-item d-flex align-items-center gap-2" href="#" style='color: rgba(224, 224, 224, 0.9); margin-bottom: 10px;'>
                                <svg
                                    fill="currentColor"
                                    height="20"
                                    viewBox="0 0 20 20"
                                    width="20"
                                    xmlns="http://www.w3.org/2000/svg"
                                >
                                    <path d="M12.73 10.127c.004-.069.02-.135.02-.205 0-.721-.29-1.413-.806-1.922A2.768 2.768 0 0 0 10 7.203c-.071 0-.138.015-.208.02l-1.05-1.037c.405-.14.83-.214 1.258-.22 1.06 0 2.078.417 2.829 1.159A3.932 3.932 0 0 1 14 9.922c-.005.423-.08.843-.222 1.242l-1.049-1.037Zm7.187-.63a10.538 10.538 0 0 0-3.954-4.748A10.72 10.72 0 0 0 10 3c-1.297 0-2.584.227-3.8.673l.985.973A9.819 9.819 0 0 1 10 4.236a9.525 9.525 0 0 1 5.242 1.514 9.368 9.368 0 0 1 3.519 4.128 9.186 9.186 0 0 1-2.526 3.455c-.047.04-.1.075-.148.114l.89.88c.024-.02.051-.037.075-.058a10.421 10.421 0 0 0 2.866-3.924c.11-.273.11-.576-.001-.849ZM3.724 3.541l12.73 12.584-.886.874-1.13-1.117a10.923 10.923 0 0 1-4.438.96 10.804 10.804 0 0 1-7.476-2.956 10.265 10.265 0 0 1-2.44-3.542 1.117 1.117 0 0 1 0-.847 10.35 10.35 0 0 1 3.453-4.392l-.7-.692.887-.872Zm9.766 11.403-1.59-1.57a3.936 3.936 0 0 1-1.9.502 4.024 4.024 0 0 1-2.829-1.159A3.932 3.932 0 0 1 6 9.922c.004-.66.179-1.306.508-1.879L4.447 6.005a9.065 9.065 0 0 0-3.208 3.961 9.64 9.64 0 0 0 2.151 3.03 9.552 9.552 0 0 0 6.61 2.61 9.669 9.669 0 0 0 3.49-.66ZM7.25 9.922c0 .72.29 1.412.806 1.922.515.51 1.215.796 1.944.797.333 0 .664-.063.974-.183L7.434 8.96a2.609 2.609 0 0 0-.184.962Z"></path>
                                </svg>
                                Show fewer posts like this
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item d-flex align-items-center gap-2" href="#" style='color: rgba(224, 224, 224, 0.9); margin-bottom: 10px;'>
                                <svg
                                    fill="currentColor"
                                    height="20"
                                    viewBox="0 0 20 20"
                                    width="20"
                                    xmlns="http://www.w3.org/2000/svg"
                                >
                                    <path d="M4.114 20A1.117 1.117 0 0 1 3 18.884V2.628A1.629 1.629 0 0 1 4.628 1h10.744A1.63 1.63 0 0 1 17 2.628v16.245a1.12 1.12 0 0 1-1.718.946L10 16.479l-5.291 3.346a1.11 1.11 0 0 1-.595.175Zm.514-17.75a.378.378 0 0 0-.378.378v16.009L10 15l5.75 3.636V2.628a.378.378 0 0 0-.378-.378H4.628Z"></path>
                                </svg>
                                Save
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item d-flex align-items-center gap-2" href="#" style='color: rgba(224, 224, 224, 0.9); margin-bottom: 10px;'>
                                <svg
                                    fill="currentColor"
                                    height="20"
                                    viewBox="0 0 20 20"
                                    width="20"
                                    xmlns="http://www.w3.org/2000/svg"
                                >
                                    <path d="M12.73 10.127c.004-.069.02-.135.02-.205 0-.721-.29-1.413-.806-1.922A2.768 2.768 0 0 0 10 7.203c-.071 0-.138.015-.208.02l-1.05-1.037c.405-.14.83-.214 1.258-.22 1.06 0 2.078.417 2.829 1.159A3.932 3.932 0 0 1 14 9.922c-.005.423-.08.843-.222 1.242l-1.049-1.037Zm7.187-.63a10.538 10.538 0 0 0-3.954-4.748A10.72 10.72 0 0 0 10 3c-1.297 0-2.584.227-3.8.673l.985.973A9.819 9.819 0 0 1 10 4.236a9.525 9.525 0 0 1 5.242 1.514 9.368 9.368 0 0 1 3.519 4.128 9.186 9.186 0 0 1-2.526 3.455c-.047.04-.1.075-.148.114l.89.88c.024-.02.051-.037.075-.058a10.421 10.421 0 0 0 2.866-3.924c.11-.273.11-.576-.001-.849ZM3.724 3.541l12.73 12.584-.886.874-1.13-1.117a10.923 10.923 0 0 1-4.438.96 10.804 10.804 0 0 1-7.476-2.956 10.265 10.265 0 0 1-2.44-3.542 1.117 1.117 0 0 1 0-.847 10.35 10.35 0 0 1 3.453-4.392l-.7-.692.887-.872Zm9.766 11.403-1.59-1.57a3.936 3.936 0 0 1-1.9.502 4.024 4.024 0 0 1-2.829-1.159A3.932 3.932 0 0 1 6 9.922c.004-.66.179-1.306.508-1.879L4.447 6.005a9.065 9.065 0 0 0-3.208 3.961 9.64 9.64 0 0 0 2.151 3.03 9.552 9.552 0 0 0 6.61 2.61 9.669 9.669 0 0 0 3.49-.66ZM7.25 9.922c0 .72.29 1.412.806 1.922.515.51 1.215.796 1.944.797.333 0 .664-.063.974-.183L7.434 8.96a2.609 2.609 0 0 0-.184.962Z"></path>
                                </svg>
                                Hide
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item d-flex align-items-center gap-2" href="#" style='color: rgba(224, 224, 224, 0.9);'>
                                <svg
                                    fill="currentColor"
                                    height="20"
                                    viewBox="0 0 20 20"
                                    width="20"
                                    xmlns="http://www.w3.org/2000/svg"
                                >
                                    <path d="M2.25 19.775H1V2.193l.353-.171a10.293 10.293 0 0 1 8.919 0 9.054 9.054 0 0 0 7.7.061l.309-.144.385.188a.715.715 0 0 1 .334.606V14.79l-.353.17a10.286 10.286 0 0 1-8.919 0 9.033 9.033 0 0 0-7.478-.16v4.975Zm3.562-6.956a10.23 10.23 0 0 1 4.46 1.016A9.04 9.04 0 0 0 17.75 14V3.531a10.17 10.17 0 0 1-8.022-.384 9.037 9.037 0 0 0-7.478-.162v10.468c1.14-.42 2.347-.635 3.562-.634Z"></path>
                                </svg>
                                Report
                            </a>
                        </li>
                    </ul>
                    
                </span>
            </h6>
            
            <a class='custom-a' style='text-decoration: none;' href="{{ post.get_absolute_url }}">
                <h4 class="card-title">
                    {{ post.title }}
                </h4>
                {% if post.media.all %}
                    <div id="carouselPost{{ post.id }}" class="carousel slide" data-bs-interval="false">
                        {% if post.media.count > 1 %}
                            <div class="carousel-indicators">
                                {% for media in post.media.all %}
                                    <button type="button" data-bs-target="#carouselPost{{ post.id }}" data-bs-slide-to="{{ forloop.counter0 }}" {% if forloop.first %}class="active" aria-current="true"{% endif %} aria-label="Slide {{ forloop.counter }}"></button>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <div class="carousel-inner">
                            {% for media in post.media.all %}
                                <div class="carousel-item mb-2 {% if forloop.first %}active{% endif %}">
                                    <div class="media-container" style="background: black; position: relative; width: 100%; aspect-ratio: {{ media.get_aspect_ratio }}; border: 1px solid rgba(173, 173, 173, 0.31); border-radius: 16px; overflow: hidden; max-height: 640px;">
                                        {% if media.media_type == 'image' %}
                                            <img src="{{ media.file.url }}" style="position: absolute; top: 50%; left: 0; width: 150%; transform: translateY(-50%) scale(1.2); opacity: 0.3; object-fit: cover; filter: blur(8px);">
                                            <img src="{{ media.file.url }}" style="position: relative; width: 100%; height: 100%; object-fit: contain;">
                                        {% elif media.media_type == 'video' %}
                                            <video controls style="width: 100%; height: 100%; object-fit: contain;">
                                                <source src="{{ media.file.url }}" type="video/mp4">
                                            </video>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>

                        {% if post.media.count > 1 %}
                            <button class="carousel-control-prev" type="button" data-bs-target="#carouselPost{{ post.id }}" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#carouselPost{{ post.id }}" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        {% endif %}
                    </div>
                {% else %}
                    {% if post.description %}
                        <p class='mb-2' style="color: rgba(255, 255, 255, 0.75);">{{ post.description }}</p>
                    {% endif %}
                {% endif %}

            
                
            </a>

            <div class="post-toolbar">
                <div class="post-rating-buttons">
                    <button class="btn btn-sm btn-secondary rounded-circle border-0" 
                        data-content-type="{{ post_content_type }}" 
                        data-object-id="{{ post.id }}" 
                        data-value="1">
                        <img src="{% static 'icons/upvote.svg' %}" 
                            data-content-type="{{ post_content_type }}" 
                            data-object-id="{{ post.id }}" 
                            data-value="1" 
                            width="16" height="16" 
                            style="filter: invert(1);">
                    </button>
                    <span class="post-rating-sum">{{ post.rating_sum }}</span>
                    <button class="btn btn-sm btn-secondary rounded-circle border-0" 
                        data-content-type="{{ post_content_type }}"
                        data-object-id="{{ post.id }}"
                        data-value="-1">
                        <img src="{% static 'icons/downvote.svg' %}" 
                            data-content-type="{{ post_content_type }}"
                            data-object-id="{{ post.id }}"
                            data-value="-1" 
                            width="16" height="16" 
                            style="filter: invert(1);">
                    </button>
                </div>
                <a href="{{ post.get_absolute_url }}" class="toolbar-button">
                    <img src="{% static 'icons/comment.svg' %}" width="16" height="16" style="filter: invert(1);">
                    <span>{{ post.comments_count }}</span>
                </a>
                <a href="/" class="toolbar-button">              
                    <img src="{% static 'icons/share.svg' %}" width="22" height="22" style="filter: invert(1);">
                    Share
                </a>
            </div>
            
        </div>
        
    </div>
    <hr style='width: 45rem;'>
    
{% endfor %}
<script src="{% static '/utils.js' %}"></script>
<script src="{% static '/ratings.js' %}"></script>
{% block script %}{% endblock script %}